version: '3'

vars:
  GO_VERSION: '1.24'
  GOLANGCI_LINT_VERSION: 'v2.1.5'
  GCI_VERSION: 'v0.13.6'
  GOFUMPT_VERSION: 'v0.8.0'
  
  BIN_DIR: '{{.ROOT_DIR}}/bin'
  GOLANGCI_LINT: '{{.BIN_DIR}}/golangci-lint'
  GCI: '{{.BIN_DIR}}/gci'
  GOFUMPT: '{{.BIN_DIR}}/gofumpt'

tasks:
  install-formatters:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä—ã gci –∏ gofumpt –≤ ./bin"
    summary: |
      –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ gofumpt –∏ gci –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ bin.
      –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –æ–Ω–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏.
      
      –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
        - gofumpt: –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ Go
        - gci: –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤ Go
    cmds:
      - |
        [ -f {{.GOFUMPT}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gofumpt {{.GOFUMPT_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
        }
        [ -f {{.GCI}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gci {{.GCI_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install github.com/daixiang0/gci@{{.GCI_VERSION}}
        }
    status:
      - test -x {{.GOFUMPT}}
      - test -x {{.GCI}}

  format:
    desc: "–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç gofumpt + gci"
    deps: [install-formatters]
    cmds:
      - |
        echo "üßº –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ gofumpt..."
        find . -type f -name '*.go' ! -path '*/vendor/*' ! -path '*/bin/*' -exec {{.GOFUMPT}} -extra -w {} +
      - |
        echo "üéØ –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç—ã —á–µ—Ä–µ–∑ gci..."
        find . -type f -name '*.go' ! -path '*/vendor/*' ! -path '*/bin/*' -exec {{.GCI}} write -s standard -s default {} +
      - echo "‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"

  install-golangci-lint:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç golangci-lint –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
    summary: |
      –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ golangci-lint –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ bin.
      –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –µ–≥–æ —á–µ—Ä–µ–∑ go install.
      
      –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º–∞—è –≤–µ—Ä—Å–∏—è: {{.GOLANGCI_LINT_VERSION}}
    cmds:
      - |
        [ -f {{.GOLANGCI_LINT}} ] || {
          mkdir -p {{.BIN_DIR}}
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º golangci-lint {{.GOLANGCI_LINT_VERSION}}..."
          GOBIN={{.BIN_DIR}} go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
        }
    status:
      - test -x {{.GOLANGCI_LINT}}

  lint:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç golangci-lint –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞"
    deps: [install-golangci-lint]
    cmds:
      - |
        echo "üîç –ó–∞–ø—É—Å–∫–∞–µ–º golangci-lint..."
        {{.GOLANGCI_LINT}} run ./... --config=.golangci.yml

  test:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞"
    cmds:
      - |
        echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã..."
        go test -v -race -cover ./...

  test:coverage:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç—ã —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –ø–æ–∫—Ä—ã—Ç–∏–µ–º"
    cmds:
      - |
        echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º..."
        go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
        go tool cover -html=coverage.out -o coverage.html
        echo "üìä –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ coverage.html"

  run:parser:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç parser –ø—Ä–æ—Ü–µ—Å—Å"
    cmds:
      - |
        if [ -f .env ]; then
          export $(cat .env | grep -v '^#' | xargs)
        fi
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º parser..."
        go run ./cmd/parser

  run:bot:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç bot –ø—Ä–æ—Ü–µ—Å—Å"
    cmds:
      - |
        if [ -f .env ]; then
          export $(cat .env | grep -v '^#' | xargs)
        fi
        echo "ü§ñ –ó–∞–ø—É—Å–∫–∞–µ–º bot..."
        go run ./cmd/bot

  run:stats:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç stats_parser –ø—Ä–æ—Ü–µ—Å—Å"
    cmds:
      - |
        if [ -f .env ]; then
          export $(cat .env | grep -v '^#' | xargs)
        fi
        echo "üìä –ó–∞–ø—É—Å–∫–∞–µ–º stats parser..."
        go run ./cmd/stats_parser

  run:fhspb:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç fhspb_parser –ø—Ä–æ—Ü–µ—Å—Å"
    cmds:
      - |
        if [ -f .env ]; then
          export $(cat .env | grep -v '^#' | xargs)
        fi
        echo "üèí –ó–∞–ø—É—Å–∫–∞–µ–º fhspb parser..."
        go run ./cmd/fhspb_parser

  build:parser:
    desc: "–°–æ–±–∏—Ä–∞–µ—Ç –±–∏–Ω–∞—Ä–Ω–∏–∫ parser"
    cmds:
      - |
        echo "üî® –°–æ–±–∏—Ä–∞–µ–º parser..."
        mkdir -p {{.BIN_DIR}}
        go build -o {{.BIN_DIR}}/parser ./cmd/parser

  build:bot:
    desc: "–°–æ–±–∏—Ä–∞–µ—Ç –±–∏–Ω–∞—Ä–Ω–∏–∫ bot"
    cmds:
      - |
        echo "üî® –°–æ–±–∏—Ä–∞–µ–º bot..."
        mkdir -p {{.BIN_DIR}}
        go build -o {{.BIN_DIR}}/bot ./cmd/bot

  build:stats:
    desc: "–°–æ–±–∏—Ä–∞–µ—Ç –±–∏–Ω–∞—Ä–Ω–∏–∫ stats_parser"
    cmds:
      - |
        echo "üî® –°–æ–±–∏—Ä–∞–µ–º stats_parser..."
        mkdir -p {{.BIN_DIR}}
        go build -o {{.BIN_DIR}}/stats_parser ./cmd/stats_parser

  build:fhspb:
    desc: "–°–æ–±–∏—Ä–∞–µ—Ç –±–∏–Ω–∞—Ä–Ω–∏–∫ fhspb_parser"
    cmds:
      - |
        echo "üî® –°–æ–±–∏—Ä–∞–µ–º fhspb_parser..."
        mkdir -p {{.BIN_DIR}}
        go build -o {{.BIN_DIR}}/fhspb_parser ./cmd/fhspb_parser

  build:all:
    desc: "–°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–∏"
    deps: [build:parser, build:bot, build:stats, build:fhspb]
    cmds:
      - echo "‚úÖ –í—Å–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–∏ —Å–æ–±—Ä–∞–Ω—ã"

  clean:
    desc: "–û—á–∏—â–∞–µ—Ç generated —Ñ–∞–π–ª—ã –∏ –±–∏–Ω–∞—Ä–Ω–∏–∫–∏"
    cmds:
      - |
        echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
        rm -rf {{.BIN_DIR}}
        rm -f coverage.out coverage.html
        echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

  db:clear:
    desc: "–û—á–∏—â–∞–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î"
    cmds:
      - |
        echo "üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞ –ë–î..."
        go run ./scripts/db_clear.go

  db:stats:
    desc: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±—ã—Å—Ç—Ä—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ë–î"
    cmds:
      - go run ./scripts/db_stats.go

  db:report:
    desc: "–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –¥–∞–Ω–Ω—ã–º –≤ –ë–î"
    cmds:
      - go run ./scripts/db_report.go

  db:verify-stats:
    desc: "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–æ–≤"
    cmds:
      - |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–æ–≤..."
        go run ./scripts/verify_player_stats.go

  db:verify-tournaments:
    desc: "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Ç—É—Ä–Ω–∏—Ä–∞–º"
    cmds:
      - |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –ø–æ —Ç—É—Ä–Ω–∏—Ä–∞–º..."
        go run ./scripts/verify_tournament_stats.go

  db:migrate:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î"
    cmds:
      - |
        echo "üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
        go run ./cmd/migrate
        echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"

  parser:full:
    desc: "–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø–∞—Ä—Å–∏–Ω–≥–∞ (–æ—á–∏—Å—Ç–∫–∞ –ë–î + –º–∏–≥—Ä–∞—Ü–∏–∏ + –ø–∞—Ä—Å–∏–Ω–≥ –≤—Å–µ—Ö –¥–æ–º–µ–Ω–æ–≤)"
    cmds:
      - |
        echo "üîß –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø–∞—Ä—Å–µ—Ä–∞..."
        task build:parser
        echo ""
        echo "üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞ –ë–î..."
        go run ./scripts/db_clear.go
        echo ""
        echo "üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
        task db:migrate
        echo ""
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –ø–∞—Ä—Å–µ—Ä –≤—Å–µ—Ö 23 –¥–æ–º–µ–Ω–æ–≤..."
        echo ""
        if [ -f .env ]; then
          export $(cat .env | grep -v '^#' | xargs)
        fi
        ./bin/parser
        echo ""
        echo "‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: task db:stats"

  stats:full:
    desc: "–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç—É—Ä–Ω–∏—Ä–æ–≤"
    cmds:
      - |
        echo "üîß –ö–æ–º–ø–∏–ª—è—Ü–∏—è stats_parser..."
        task build:stats
        echo ""
        echo "üìä –ó–∞–ø—É—Å–∫–∞—é –ø–∞—Ä—Å–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—Å–µ—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤..."
        if [ -f .env ]; then
          export $(cat .env | grep -v '^#' | xargs)
        fi
        ./bin/stats_parser
        echo ""
        echo "‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo "üìä –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
        echo "   task db:stats              # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
        echo "   task db:verify-stats       # –ü–æ–∫—Ä—ã—Ç–∏–µ –∏–≥—Ä–æ–∫–æ–≤"
        echo "   task db:verify-tournaments # –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç—É—Ä–Ω–∏—Ä–æ–≤"

  help:
    desc: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞—á"
    cmds:
      - task --list
