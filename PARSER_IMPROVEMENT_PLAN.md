# План улучшения парсеров и системы данных

## 1. Очистка БД vs Инкрементальное обновление

### Полная очистка БД:
**Плюсы:**
- Гарантированно свежие данные
- Нет проблем с дублированием
- Простая логика парсера

**Минусы:**
- Потеря исторических данных
- Долгое время восстановления (часы)
- Простой сервиса на время парсинга

### Инкрементальное обновление (рекомендуется):
**Плюсы:**
- Сохранение исторических данных
- Быстрое обновление только новых данных
- Сервис работает постоянно

**Минусы:**
- Сложная логика обработки существующих данных
- Возможны дубли и конфликты

## 2. Логика работы с существующими данными

### Стратегия UPSERT:
```
IF запись существует:
    IF новые данные свежее (по дате):
        UPDATE с сохранением важных полей
    ELSE:
        SKIP (не перезаписываем более свежие данные)
ELSE:
    INSERT новую запись
```

### Ключевые принципы:
- **Игроки:** Обновлять только если данные полнее (позиция, рост, вес)
- **Команды:** Обновлять названия и города
- **Статистика:** Обновлять только текущий сезон
- **Турниры:** Обновлять статус завершения

## 3. Система повторных попыток для пропущенных данных

### Архитектура:
```sql
CREATE TABLE failed_parsing_attempts (
    id SERIAL PRIMARY KEY,
    url TEXT NOT NULL,
    error_message TEXT,
    attempt_count INTEGER DEFAULT 1,
    last_attempt_at TIMESTAMP DEFAULT NOW(),
    next_retry_at TIMESTAMP,
    parser_type VARCHAR(50), -- 'fhspb', 'junior', 'stats'
    permanently_failed BOOLEAN DEFAULT FALSE
);
```

### Retry логика:
- Экспоненциальная задержка: 1h → 4h → 16h → 64h
- Максимум 5 попыток
- После 5 неудач - пометка как "permanently failed"

### Отдельный процесс retry_worker:
- Запускается каждый час
- Берет записи где next_retry_at <= NOW()
- Пытается повторно спарсить

### Типы ошибок для retry:
- **Временные:** Сетевые ошибки, таймауты → RETRY
- **Постоянные:** 404, неверный формат данных → NO RETRY
- **Парсинг:** Изменился HTML → RETRY (может исправят)

## 4. Мониторинг и алерты

### Метрики для отслеживания:
- Процент успешно спарсенных страниц
- Количество failed_attempts
- Время выполнения парсинга
- Количество обновленных/новых записей

### Алерты:
- Если success rate < 90% → уведомление
- Если failed_attempts > 100 → проверить парсер
- Если парсинг длится > 2 часов → возможно проблема

## 5. План действий

### Этап 1: Подготовка
1. Добавить retry механизм в парсеры
2. Улучшить UPSERT логику
3. Добавить мониторинг

### Этап 2: Тестирование
1. Запустить парсер на копии БД
2. Проверить корректность обновлений
3. Измерить время выполнения

### Этап 3: Продакшн
1. Запустить инкрементальное обновление
2. Мониторить процесс
3. При необходимости - откат к полной очистке

## 6. Улучшение FHSPB парсера

### Текущие проблемы:
- Не заполняется поле `url` в таблице tournaments
- Не заполняется поле `domain` в таблице tournaments
- Данные менее структурированы по сравнению с junior парсером

### План улучшений:
1. **Tournaments:** Добавить заполнение url и domain полей
2. **Teams:** Улучшить структуру данных команд
3. **Players:** Обогатить профили игроков
4. **Statistics:** Унифицировать со структурой junior данных

---

*Создано: 2025-12-18*
*Статус: В разработке*
